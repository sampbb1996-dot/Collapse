<script>
let times = [];
let signal = 0;
const ALPHA = 0.25;

let touching = false;
const zone = document.getElementById("zone");

zone.addEventListener("pointerdown", () => {
  touching = true;
});

zone.addEventListener("pointerup", () => {
  if (!touching) return;
  touching = false;
  tap();
});

zone.addEventListener("pointercancel", () => touching = false);

function tap() {
  const t = performance.now();
  times.push(t);

  if (times.length < 4) {
    render(signal);
    return;
  }

  const a = times.at(-1) - times.at(-2);
  const b = times.at(-2) - times.at(-3);
  const c = times.at(-3) - times.at(-4);

  const r1 = a / b;
  const r2 = b / c;

  const error = Math.abs(r1 - r2); // >= 0 always

  // smooth but never evolve without evidence
  signal = ALPHA * error + (1 - ALPHA) * signal;

  // hard safety: structural error cannot be negative
  if (signal < 0) signal = 0;

  render(signal);
}

function render(v) {
  document.getElementById("value").textContent = v.toFixed(4);
}

document.getElementById("reset").onclick = () => {
  times = [];
  signal = 0;
  render(0);
};
</script>
