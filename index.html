<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
/>

<title>CORE — Collapse Timing</title>

<style>
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
  }

  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  .container {
    width: 92%;
    max-width: 420px;
    text-align: center;
  }

  .display {
    background: #111;
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 16px;
    font-size: 32px;
    letter-spacing: 0.04em;
  }

  .sub {
    font-size: 14px;
    opacity: 0.6;
    margin-top: 6px;
  }

  button {
    width: 100%;
    padding: 18px;
    margin: 10px 0;
    font-size: 18px;
    border-radius: 14px;
    border: none;
    background: #1c1c1c;
    color: white;
  }

  button:active {
    background: #2a2a2a;
  }

  button:disabled {
    opacity: 0.4;
  }

  .ceiling {
    margin-top: 12px;
    font-size: 12px;
    opacity: 0.5;
  }
</style>
</head>

<body>
<div class="container">

  <div class="display" id="mainDisplay">READY</div>
  <div class="sub" id="subDisplay">Tap START to begin</div>

  <button id="tapBtn" disabled>TAP</button>
  <button id="startBtn">START</button>
  <button id="endBtn">× END</button>

  <div class="ceiling" id="ceilingInfo"></div>

</div>

<script>
/* =========================
   CORE STATE
========================= */

let active = false;
let locked = false;

let targetInterval = 600; // ms
let windowSize = 120;     // ms (adaptive)
let ceilingWindow = 45;   // corpus ceiling

let lastTargetTime = null;
let lastTapTime = null;

let stabilityScore = 0;
let tapCount = 0;

let runLog = [];

/* =========================
   UTILS
========================= */

function now() {
  return performance.now();
}

function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}

/* =========================
   GAME LOGIC
========================= */

function startGame() {
  active = true;
  locked = false;

  tapCount = 0;
  stabilityScore = 0;
  windowSize = 120;
  runLog = [];

  lastTargetTime = now();

  updateUI("RUNNING", "Find the rhythm");
  tapBtn.disabled = false;

  tick();
}

function tick() {
  if (!active || locked) return;

  lastTargetTime += targetInterval;

  setTimeout(tick, targetInterval);
}

function handleTap() {
  if (!active || locked) return;

  const t = now();
  const delta = Math.abs(t - lastTargetTime);

  const hit = delta <= windowSize;

  tapCount++;

  if (hit) {
    stabilityScore++;
    windowSize = clamp(windowSize * 0.93, ceilingWindow, 200);
  } else {
    stabilityScore--;
    windowSize = clamp(windowSize * 1.08, ceilingWindow, 240);
  }

  runLog.push({
    tap: tapCount,
    delta: Math.round(delta),
    window: Math.round(windowSize),
    hit
  });

  updateUI(
    hit ? "✓" : "✕",
    `Δ ${Math.round(delta)} ms | window ±${Math.round(windowSize)}`
  );

  checkTerminal();
}

function checkTerminal() {
  if (windowSize <= ceilingWindow && stabilityScore >= 12) {
    collapse("CEILING STABLE");
  }

  if (stabilityScore <= -6) {
    collapse("UNSTABLE");
  }
}

function collapse(reason) {
  locked = true;
  active = false;

  tapBtn.disabled = true;

  updateUI("COLLAPSE", reason);

  exportRun();
}

/* =========================
   EXPORT
========================= */

function exportRun() {
  const data = {
    taps: tapCount,
    finalWindow: Math.round(windowSize),
    stabilityScore,
    log: runLog
  };

  console.log("CORE RUN:", data);
}

/* =========================
   UI
========================= */

function updateUI(main, sub) {
  mainDisplay.textContent = main;
  subDisplay.textContent = sub;
  ceilingInfo.textContent = `Ceiling window: ±${ceilingWindow} ms`;
}

/* =========================
   EVENTS
========================= */

tapBtn.addEventListener("click", handleTap);

startBtn.addEventListener("click", startGame);

endBtn.addEventListener("click", () => {
  if (active && !locked) collapse("MANUAL END");
});

/* =========================
   INIT
========================= */

updateUI("READY", "Temporal precision task");
</script>
</body>
</html>
