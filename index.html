<script>
/* =========================
   CONFIG (defensible)
========================= */
const DISPLAY_ALPHA = 0.9;     // inertia
const BASE_WINDOW = 12;       // number of taps
const MIN_WINDOW  = 6;
const MAX_WINDOW  = 24;

const VAR_FLOOR = 4;          // ms² ~ human noise floor
const VAR_CEIL  = 400;        // ms² ~ total breakdown

/* =========================
   STATE
========================= */
let sessionActive = true;
let windowSize = BASE_WINDOW;

let intervals = [];
let displayValue = 0.5;
let lastDisplay = 0.5;
let lastTapTime = null;

/* =========================
   HELPERS
========================= */
const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
const mean  = a => a.reduce((x,y)=>x+y,0) / a.length;

/* =========================
   TAP
========================= */
function tap() {
  if (!sessionActive) return;

  const now = performance.now();

  if (lastTapTime === null) {
    lastTapTime = now;
    paint();
    return;
  }

  const delta = now - lastTapTime;
  lastTapTime = now;

  intervals.push(delta);
  if (intervals.length > windowSize) intervals.shift();

  if (intervals.length < 3) {
    paint();
    return;
  }

  const avg = mean(intervals);
  const variance =
    mean(intervals.map(d => (d - avg) ** 2));

  /* consistency only */
  const normalized =
    1 - clamp(
      (variance - VAR_FLOOR) / (VAR_CEIL - VAR_FLOOR),
      0, 1
    );

  displayValue =
    DISPLAY_ALPHA * displayValue +
    (1 - DISPLAY_ALPHA) * normalized;

  /* adaptive window (stable → shrink, unstable → expand) */
  if (variance > VAR_CEIL * 0.6 && windowSize < MAX_WINDOW) {
    windowSize++;
  } else if (variance < VAR_FLOOR * 2 && windowSize > MIN_WINDOW) {
    windowSize--;
  }

  paint();
}

/* =========================
   END
========================= */
function endSession() {
  sessionActive = false;
}

/* =========================
   DISPLAY
========================= */
function paint() {
  const el = document.getElementById("reader");
  const d  = displayValue - lastDisplay;

  el.textContent = displayValue.toFixed(3);

  if (d > 0)      el.style.color = "#2ecc71";
  else if (d < 0) el.style.color = "#e74c3c";
  else            el.style.color = "#ffffff";

  lastDisplay = displayValue;
}
</script>
