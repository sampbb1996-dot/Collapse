const MAX_WINDOW = 20;
const ALPHA = 0.2; // smoothing strength (lower = smoother)

let lastTap = null;
let window = [];
let mean = null;

function onTap(time) {
  if (lastTap === null) {
    lastTap = time;
    mean = 0;
    window = [0];
    return { interval: 0, percent: 0 };
  }

  const interval = time - lastTap;
  lastTap = time;

  // update smoothed mean
  mean = mean === null
    ? interval
    : ALPHA * interval + (1 - ALPHA) * mean;

  // use mean, not raw interval
  window.push(mean);
  if (window.length > MAX_WINDOW) {
    window.shift();
  }

  if (window.length < 2) {
    return { interval: mean, percent: 0 };
  }

  const min = Math.min(...window);
  const max = Math.max(...window);

  if (min === max) {
    return { interval: mean, percent: 0 };
  }

  const percent =
    Math.min(
      100,
      Math.max(
        0,
        ((mean - min) / (max - min)) * 100
      )
    );

  return {
    interval: mean,
    percent
  };
}
