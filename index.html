<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mean + Noise</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #2b2b2b;
    overflow: hidden;
    touch-action: manipulation;
  }
  canvas { display: block; }
  #audioBtn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 14px 22px;
    border-radius: 18px;
    border: none;
    background: #ff9800;
    color: #111;
    font-size: 16px;
  }
</style>
</head>
<body>

<canvas id="c"></canvas>
<button id="audioBtn">Enable Audio</button>

<script>
/* -------------------------
   STATE
-------------------------- */

// latent mean (what matters)
let m = 0.5;          // equilibrium
// instantaneous state (what you perceive)
let x = 0.5;

const meanDecay = 0.0006;   // m → 0.5
const pullToMean = 0.04;    // x → m
const noiseAmp = 0.08;      // local variance

/* -------------------------
   CANVAS
-------------------------- */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* -------------------------
   AUDIO
-------------------------- */

let audioCtx, noiseNode, gainNode;
let audioEnabled = false;

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < data.length; i++) {
    data[i] = Math.random() * 2 - 1;
  }

  noiseNode = audioCtx.createBufferSource();
  noiseNode.buffer = buffer;
  noiseNode.loop = true;

  gainNode = audioCtx.createGain();
  gainNode.gain.value = 0;

  noiseNode.connect(gainNode).connect(audioCtx.destination);
  noiseNode.start();
}

/* -------------------------
   INPUT
-------------------------- */

document.getElementById("audioBtn").onclick = () => {
  if (!audioEnabled) {
    initAudio();
    audioEnabled = true;
    document.getElementById("audioBtn").remove();
  }
};

document.body.addEventListener("pointerdown", () => {
  if (!audioEnabled) return;
  // taps nudge the MEAN, not raw noise
  m += (Math.random() - 0.5) * 0.08;
  m = Math.max(0, Math.min(1, m));
});

/* -------------------------
   UPDATE + RENDER
-------------------------- */

function step() {
  // mean relaxes back to 0.5
  m += (0.5 - m) * meanDecay;

  // instantaneous state fluctuates but is pulled to mean
  x += (Math.random() - 0.5) * noiseAmp;
  x += (m - x) * pullToMean;
  x = Math.max(0, Math.min(1, x));

  // audio follows instantaneous state
  if (audioEnabled) {
    gainNode.gain.value = 0.25 * x;
  }

  // visual noise centered on x
  const img = ctx.createImageData(canvas.width, canvas.height);
  const d = img.data;

  const baseR = 150 + x * 70;
  const baseG = 120 + x * 40;
  const baseB = 60  + x * 20;

  for (let i = 0; i < d.length; i += 4) {
    const n = (Math.random() - 0.5) * 50;
    d[i]     = baseR + n;
    d[i + 1] = baseG + n;
    d[i + 2] = baseB + n;
    d[i + 3] = 255;
  }

  ctx.putImageData(img, 0, 0);
  requestAnimationFrame(step);
}

step();
</script>
</body>
</html>
