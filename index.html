<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>

<title>Collapse</title>

<style>
  /* ---------------------------
     GLOBAL HARD LOCKS (iOS FIX)
     --------------------------- */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
  }

  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    height: 100%;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* ---------------------------
     LAYOUT
     --------------------------- */
  .container {
    width: 90%;
    max-width: 420px;
    text-align: center;
  }

  .panel {
    background: #111;
    border-radius: 18px;
    padding: 22px;
    margin-bottom: 16px;
  }

  .status {
    font-size: 28px;
    letter-spacing: 2px;
    margin-bottom: 8px;
  }

  .sub {
    font-size: 14px;
    opacity: 0.6;
  }

  .metric {
    font-size: 16px;
    margin-top: 10px;
    opacity: 0.75;
  }

  button {
    width: 100%;
    padding: 18px;
    margin-top: 12px;
    border-radius: 14px;
    border: none;
    background: #1c1c1c;
    color: #fff;
    font-size: 18px;
    letter-spacing: 1px;
  }

  button:disabled {
    opacity: 0.3;
  }

  .danger {
    background: #2a0f0f;
  }

  .collapse {
    font-size: 32px;
    letter-spacing: 3px;
  }
</style>
</head>

<body>
<div class="container">

  <div class="panel">
    <div id="status" class="status">READY</div>
    <div id="state" class="sub">idle</div>
    <div id="metrics" class="metric">—</div>
  </div>

  <button id="tapBtn" disabled>TAP</button>
  <button id="startBtn">START</button>
  <button id="endBtn" class="danger">× END</button>

</div>

<script>
/* ---------------------------
   CORE STATE
--------------------------- */
let running = false
let collapsed = false

let lastTap = null
let deltas = []

let target = 200            // ms
let window = 130            // adaptive window
const CEILING = 45          // ceiling corpus (hard lower bound)

let runLog = []

/* ---------------------------
   UI
--------------------------- */
const statusEl = document.getElementById("status")
const stateEl = document.getElementById("state")
const metricsEl = document.getElementById("metrics")

const tapBtn = document.getElementById("tapBtn")
const startBtn = document.getElementById("startBtn")
const endBtn = document.getElementById("endBtn")

/* ---------------------------
   HELPERS
--------------------------- */
function mean(arr) {
  return arr.reduce((a,b)=>a+b,0)/arr.length
}

function std(arr) {
  const m = mean(arr)
  return Math.sqrt(mean(arr.map(x => (x-m)**2)))
}

/* ---------------------------
   GAME LOGIC
--------------------------- */
function start() {
  running = true
  collapsed = false
  lastTap = null
  deltas = []
  window = 130

  runLog = []

  statusEl.textContent = "STABILIZE"
  stateEl.textContent = "running"
  metricsEl.textContent = `target ${target}ms | window ±${window}`

  tapBtn.disabled = false
}

function end(cause = "manual") {
  running = false
  tapBtn.disabled = true

  if (cause === "collapse") {
    collapsed = true
    statusEl.textContent = "COLLAPSE"
    stateEl.textContent = "unstable"
  } else {
    statusEl.textContent = "ENDED"
    stateEl.textContent = "idle"
  }

  exportRun()
}

function tap() {
  if (!running || collapsed) return

  const now = performance.now()

  if (lastTap !== null) {
    const delta = now - lastTap
    const err = Math.abs(delta - target)

    deltas.push(err)

    runLog.push({
      t: now,
      delta,
      err,
      window
    })

    // collapse condition
    if (err > window) {
      end("collapse")
      return
    }

    // adaptive tightening
    if (deltas.length >= 
