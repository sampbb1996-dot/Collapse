<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Timing</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  touch-action: manipulation;
}

* {
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
}

.container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 24px;
}

.panel {
  width: 86%;
  max-width: 420px;
  padding: 30px;
  border-radius: 18px;
  background: #141414;
  text-align: center;
  font-size: 48px;
  transition: color 0.25s ease;
}

.btn {
  width: 86%;
  max-width: 420px;
  padding: 22px;
  border-radius: 18px;
  background: #1f1f1f;
  text-align: center;
  font-size: 20px;
}

.btn:active {
  background: #2a2a2a;
}
</style>
</head>

<body>
<div class="container">

  <div id="score" class="panel">0%</div>

  <div id="tap" class="btn">TAP</div>
  <div id="start" class="btn">START</div>

</div>

<script>
/* ================= CORE STATE ================= */

let running = false;
let lastTap = null;
let intervals = [];

let adaptiveWindow = 240;      // start wide (max signal retention)
const ceilingWindow = 45;      // domain ceiling (hard anchor)
const minWindow = 35;          // safety floor

let lastScore = 0;

/* ================= HELPERS ================= */

function mean(arr) {
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

function std(arr, m) {
  return Math.sqrt(
    arr.reduce((a,b)=>a+(b-m)*(b-m),0) / arr.length
  );
}

function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}

/* ================= CORE LOGIC ================= */

function updateScore() {
  if (intervals.length < 4) return;

  const m = mean(intervals);
  const s = std(intervals, m);

  // Stability = variance relative to current envelope
  let stability = 1 - (s / adaptiveWindow);
  stability = clamp(stability, 0, 1);

  const score = Math.round(stability * 100);
  const el = document.getElementById("score");

  // Directional color only
  if (score >= lastScore) {
    el.style.color = "#4caf50"; // green
  } else {
    el.style.color = "#f44336"; // red
  }

  el.textContent = score + "%";
  lastScore = score;

  /* ---------------- Adaptive window logic ----------------
     - Instability → expand envelope (preserve signal)
     - Stability   → tighten envelope (increase resolution)
     ------------------------------------------------------ */

  if (s > adaptiveWindow * 0.6) {
    adaptiveWindow *= 1.10;   // expand quickly when unstable
  } else {
    adaptiveWindow *= 0.97;   // tighten slowly when stable
  }

  adaptiveWindow = clamp(adaptiveWindow, ceilingWindow, 400);
}

/* ================= EVENTS ================= */

document.getElementById("tap").onclick = () => {
  if (!running) return;

  const now = performance.now();

  if (lastTap !== null) {
    const delta = now - lastTap;
    intervals.push(delta);

    if (intervals.length > 20) {
      intervals.shift();
    }

    updateScore();
  }

  lastTap = now;
};

document.getElementById("start").onclick = () => {
  running = true;
  lastTap = null;
  intervals = [];
  adaptiveWindow = 240;
  lastScore = 0;

  const el = document.getElementById("score");
  el.textContent = "0%";
  el.style.color = "#4caf50";
};
</script>
</body>
</html>
