<script>
/* -------- Governor -------- */

class Governor {
  allowsChange(state) {
    return (
      state.calm === true &&
      state.strategyDetected === false &&
      state.varianceLow === true
    );
  }
}

/* -------- State -------- */

const state = {
  window: 300,          // ms reaction window
  calm: true,
  varianceLow: true,
  strategyDetected: false
};

const governor = new Governor();

/* -------- Mechanics -------- */

function observeStimulus() {
  // non-salient visual noise handled elsewhere
}

function getAction(startTime) {
  const reactionTime = performance.now() - startTime;
  return reactionTime <= state.window;
}

function tighten() {
  state.window *= 0.97;
}

function loosen() {
  state.window *= 1.03;
}

/* -------- Main Loop -------- */

function runTrial() {
  observeStimulus();
  const start = performance.now();

  document.addEventListener(
    "pointerup",
    () => {
      const hit = getAction(start);

      // TERMINAL GOVERNOR
      if (governor.allowsChange(state)) {
        if (hit) tighten();
        else loosen();
      }
      // else: do absolutely nothing
    },
    { once: true }
  );
}
</script>
