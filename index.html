<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibration</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: manipulation;
  }

  #wrap {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  canvas {
    display: block;
  }

  button {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    padding: 22px 28px;
    font-size: 18px;
    border-radius: 22px;
    border: none;
    background: #777;
    color: #000;
  }
</style>
</head>
<body>

<div id="wrap">
  <canvas id="c"></canvas>
</div>

<button id="start">START</button>

<script>
/* =====================
   CANVAS (square, centered)
===================== */
const c = document.getElementById("c");
const ctx = c.getContext("2d");

function resize() {
  const size = Math.min(innerWidth, innerHeight);
  c.width = size;
  c.height = size;
}
addEventListener("resize", resize);
resize();

/* =====================
   TIME-OF-DAY DRIFT
===================== */
function dayFraction() {
  const d = new Date();
  const s =
    d.getHours() * 3600 +
    d.getMinutes() * 60 +
    d.getSeconds() +
    d.getMilliseconds() / 1000;
  return s / 86400;
}

function daylight01() {
  const p = dayFraction();
  return 0.5 - 0.5 * Math.cos(2 * Math.PI * p);
}

/* =====================
   SHARED STATE
===================== */
let level = 0.5;
let noise = 0.04;
const pull = 0.01;

/* =====================
   AUDIO (tap-only start)
===================== */
let audioCtx, src, gain, filter;

function startAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioCtx.resume();

  const buf = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;

  src = audioCtx.createBufferSource();
  src.buffer = buf;
  src.loop = true;

  filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";

  gain = audioCtx.createGain();

  src.connect(filter).connect(gain).connect(audioCtx.destination);
  src.start();
}

/* =====================
   INPUT
===================== */
document.body.addEventListener("pointerdown", () => {
  if (!gain) return;
  noise += 0.012;
});

/* =====================
   LOOP
===================== */
function loop() {
  const day = daylight01();
  const baseline = 0.42 + day * 0.16;

  level += (baseline - level) * pull;
  level += (Math.random() - 0.5) * noise;
  level = Math.max(0, Math.min(1, level));

  noise *= 0.995;

  // AUDIO MAP
  if (gain) {
    gain.gain.value = 0.22 + level * 0.45;
    filter.frequency.value = 300 + level * 1400;
  }

  // VISUAL MAP (square field)
  const tile = 14;
  for (let y = 0; y < c.height; y += tile) {
    for (let x = 0; x < c.width; x += tile) {
      const v = 60 + level * 160 + (Math.random() - 0.5) * 40;
      ctx.fillStyle = `rgb(${v},${v},${v})`;
      ctx.fillRect(x, y, tile, tile);
    }
  }

  requestAnimationFrame(loop);
}

/* =====================
   START
===================== */
document.getElementById("start").onclick = () => {
  startAudio();
  document.getElementById("start").remove();
  loop();
};
</script>
</body>
</html>
