<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>

<title>CORE — Collapse Timing</title>

<style>
/* =========================
   GLOBAL HARD BLOCKS
   ========================= */
* {
  -webkit-tap-highlight-color: transparent !important;
  -webkit-touch-callout: none !important;
  -webkit-user-select: none !important;
  user-select: none !important;
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
  overflow: hidden;
  touch-action: manipulation;
}

/* =========================
   LAYOUT
   ========================= */
.app {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 22px;
}

.display {
  width: 88%;
  height: 90px;
  border-radius: 18px;
  background: #0e1b2f;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  letter-spacing: 0.5px;
}

button {
  width: 88%;
  height: 64px;
  border-radius: 18px;
  border: none;
  background: #1f1f1f;
  color: #fff;
  font-size: 18px;
  letter-spacing: 1px;
}

button:active {
  transform: scale(0.98);
}

button.secondary {
  background: #121212;
  opacity: 0.7;
}

/* =========================
   STATE COLORING
   ========================= */
.stable {
  background: #0e1b2f;
}

.collapsing {
  background: #2f1b0e;
}

.collapsed {
  background: #2f0e0e;
}
</style>
</head>

<body>
<div class="app">

  <div id="display" class="display stable">—</div>

  <button id="tap">TAP</button>
  <button id="start" class="secondary">START</button>
  <button id="end" class="secondary">× END</button>

</div>

<script>
/* =========================
   CORE STATE
   ========================= */
let running = false;
let lastTap = null;
let samples = [];
let startTime = null;

const IMPULSE_WINDOW = 340; // ms — widened to avoid iOS micro-bounce
const MAX_SAMPLES = 20;

/* =========================
   HELPERS
   ========================= */
function mean(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}

function variance(arr) {
  const m = mean(arr);
  return mean(arr.map(x => (x - m) ** 2));
}

function clamp(n, min, max) {
  return Math.min(max, Math.max(min, n));
}

/* =========================
   DISPLAY UPDATE
   ========================= */
function updateDisplay() {
  if (samples.length < 2) {
    display.textContent = "—";
    display.className = "display stable";
    return;
  }

  const v = variance(samples);
  const signal = clamp(1 / (1 + v), 0, 1);

  display.textContent = signal.toFixed(3);

  if (signal > 0.75) {
    display.className = "display stable";
  } else if (signal > 0.4) {
    display.className = "display collapsing";
  } else {
    display.className = "display collapsed";
  }
}

/* =========================
   EVENTS
   ========================= */
tap.onclick = () => {
  if (!running) return;

  const now = performance.now();

  if (lastTap !== null) {
    const delta = now - lastTap;

    // Ignore accidental micro-taps
    if (delta < IMPULSE_WINDOW) return;

    samples.push(delta);
    if (samples.length > MAX_SAMPLES) samples.shift();

    updateDisplay();
  }

  lastTap = now;
};

start.onclick = () => {
  running = true;
  samples = [];
  lastTap = null;
  startTime = performance.now();
  display.textContent = "—";
  display.className = "display stable";
};

end.onclick = () => {
  running = false;
};

/* =========================
   SAFETY: BLOCK ZOOM / DBL TAP
   ========================= */
let lastTouchEnd = 0;
document.addEventListener("touchend", e => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, { passive: false });
</script>
</body>
</html>
