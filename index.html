<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Specificity</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: manipulation;
  }
  canvas { display: block; }
  #status {
    position: fixed;
    bottom: 16px;
    width: 100%;
    text-align: center;
    color: #666;
    font-family: system-ui, sans-serif;
    font-size: 12px;
  }
</style>
</head>
<body>

<canvas id="c"></canvas>
<div id="status">calibrating</div>

<script>
/* -------------------------
   STATE (HIDDEN)
-------------------------- */

// latent calibration (slow, hidden)
let mean = 0.5;

// perceived state (fast, noisy)
let x = 0.5;

// noise + pull parameters
let noiseAmp = 0.06;
const pull = 0.03;
const meanDecay = 0.0004;

// calibration tracking
let lastX = x;
let variance = 0;
let samples = 0;

// stop conditions
let unstableCount = 0;
let stableCount = 0;

/* -------------------------
   CANVAS
-------------------------- */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* -------------------------
   INPUT (PERTURBS UNCERTAINTY ONLY)
-------------------------- */

document.body.addEventListener("pointerdown", () => {
  // input increases uncertainty slightly
  noiseAmp += 0.005;
});

/* -------------------------
   UPDATE LOOP
-------------------------- */

function step() {

  // latent mean drifts slowly back to neutral
  mean += (0.5 - mean) * meanDecay;

  // noisy surface state
  x += (Math.random() - 0.5) * noiseAmp;
  x += (mean - x) * pull;
  x = Math.max(0, Math.min(1, x));

  // track variance of perception
  const dx = x - lastX;
  variance = 0.98 * variance + 0.02 * dx * dx;
  lastX = x;

  samples++;

  // adaptive gating
  if (variance > 0.002) {
    unstableCount++;
    noiseAmp *= 0.98; // dampen
  } else {
    stableCount++;
  }

  // stop conditions
  if (unstableCount > 300) {
    end("stopped (noise)");
    return;
  }
  if (stableCount > 1200) {
    end("complete");
    return;
  }

  render();
  requestAnimationFrame(step);
}

/* -------------------------
   RENDER
-------------------------- */

function render() {
  const img = ctx.createImageData(canvas.width, canvas.height);
  const d = img.data;

  const base = 40 + x * 60;

  for (let i = 0; i < d.length; i += 4) {
    const n = (Math.random() - 0.5) * 30;
    d[i] = d[i+1] = d[i+2] = base + n;
    d[i+3] = 255;
  }

  ctx.putImageData(img, 0, 0);
}

/* -------------------------
   END
-------------------------- */

function end(msg) {
  document.getElementById("status").textContent = msg;
}

/* -------------------------
   START
-------------------------- */

step();
</script>
</body>
</html>
