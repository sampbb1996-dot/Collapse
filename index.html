<script>
document.addEventListener("DOMContentLoaded", () => {

/* =========================
   CONFIG (LOCKED)
========================= */
const DISPLAY_ALPHA = 0.88;
const FAST_WINDOW = 8;
const SLOW_ALPHA = 0.02;

const VAR_FLOOR = 6;
const VAR_CEIL  = 500;

/* =========================
   STATE
========================= */
let sessionActive = true;

let lastTapTime = null;
let fastIntervals = [];

let slowMean = null;
let displayValue = 0.5;
let lastDisplay = 0.5;

const reader = document.getElementById("reader");

/* =========================
   HELPERS
========================= */
const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
const mean  = a => a.reduce((x,y)=>x+y,0) / a.length;

/* =========================
   TAP
========================= */
window.tap = function () {
  if (!sessionActive || !reader) return;

  const now = performance.now();

  if (lastTapTime === null) {
    lastTapTime = now;
    paint();
    return;
  }

  const delta = now - lastTapTime;
  lastTapTime = now;

  fastIntervals.push(delta);
  if (fastIntervals.length > FAST_WINDOW) fastIntervals.shift();

  if (fastIntervals.length < 4) {
    paint();
    return;
  }

  const fastMean = mean(fastIntervals);

  if (slowMean === null || !isFinite(slowMean)) {
    slowMean = fastMean;
  } else {
    slowMean = (1 - SLOW_ALPHA) * slowMean + SLOW_ALPHA * fastMean;
  }

  const error = Math.abs(fastMean - slowMean);

  const variance =
    mean(fastIntervals.map(d => (d - fastMean) ** 2));

  const stability =
    1 - clamp(
      (variance - VAR_FLOOR) / (VAR_CEIL - VAR_FLOOR),
      0, 1
    );

  const alignment =
    slowMean > 0
      ? 1 - clamp(error / slowMean, 0, 1)
      : 0;

  const estimate = stability * alignment;

  displayValue =
    DISPLAY_ALPHA * displayValue +
    (1 - DISPLAY_ALPHA) * estimate;

  paint();
};

/* =========================
   END
========================= */
window.endSession = function () {
  sessionActive = false;
};

/* =========================
   DISPLAY
========================= */
function paint() {
  if (!reader || !isFinite(displayValue)) return;

  const d = displayValue - lastDisplay;

  reader.textContent = displayValue.toFixed(3);

  if (d > 0)      reader.style.color = "#2ecc71";
  else if (d < 0) reader.style.color = "#e74c3c";
  else            reader.style.color = "#ffffff";

  lastDisplay = displayValue;
}

});
</script>
