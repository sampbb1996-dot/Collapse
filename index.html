<script>
/* =========================
   CONFIG
========================= */
const MIN_WINDOW = 150;
const MAX_WINDOW = 900;
const BASE_WINDOW = 300;

const DISPLAY_ALPHA = 0.90; // slightly more responsive
const EXPAND_RATE = 0.4;
const CONTRACT_RATE = 0.12;

/* =========================
   STATE
========================= */
let corpus = [];
let windowed = [];

let windowSize = BASE_WINDOW;

let displayValue = 0.5;
let lastDisplay = 0.5;

let lastTapTime = null;

/* =========================
   HELPERS
========================= */
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

/* =========================
   TAP
========================= */
function tap() {
  const now = performance.now();

  // FIRST TAP: force a visible update
  if (lastTapTime === null) {
    lastTapTime = now;
    forceDisplay();
    return;
  }

  const delta = now - lastTapTime;
  lastTapTime = now;

  corpus.push(delta);
  windowed.push(delta);

  // adaptive window slice
  windowed = windowed.filter(d => d < windowSize);

  // --- instability ---
  const avg = mean(windowed);
  const variance = mean(windowed.map(d => (d - avg) ** 2));
  const instability = Math.sqrt(variance);

  if (instability > 30) {
    windowSize = clamp(
      windowSize + instability * EXPAND_RATE,
      MIN_WINDOW,
      MAX_WINDOW
    );
  } else {
    windowSize = clamp(
      windowSize - windowSize * CONTRACT_RATE,
      MIN_WINDOW,
      MAX_WINDOW
    );
  }

  // normalized estimate
  const estimate = clamp(1 - avg / windowSize, 0, 1);

  // inertial update
  displayValue =
    DISPLAY_ALPHA * displayValue +
    (1 - DISPLAY_ALPHA) * estimate;

  updateDisplay();
}

/* =========================
   DISPLAY
========================= */
function forceDisplay() {
  const el = document.getElementById("reader");
  el.textContent = displayValue.toFixed(3);
  el.style.color = "#fff";
}

function updateDisplay() {
  const el = document.getElementById("reader");
  const delta = displayValue - lastDisplay;

  el.textContent = displayValue.toFixed(3);

  if (delta > 0) {
    el.style.color = "#2ecc71"; // green
  } else if (delta < 0) {
    el.style.color = "#e74c3c"; // red
  }

  lastDisplay = displayValue;
}
</script>
