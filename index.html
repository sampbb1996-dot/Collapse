<script>
/* =========================
   CONFIG
========================= */
const MIN_WINDOW = 150;     // ms
const MAX_WINDOW = 900;
const BASE_WINDOW = 300;

const DISPLAY_ALPHA = 0.92; // inertia
const EXPAND_RATE = 0.4;
const CONTRACT_RATE = 0.12;

/* =========================
   STATE
========================= */
let sessionActive = false;

let corpus = [];           // full session memory
let windowed = [];         // adaptive slice

let windowSize = BASE_WINDOW;

let displayValue = 0.5;
let lastDisplay = 0.5;

let lastTapTime = null;

/* =========================
   HELPERS
========================= */
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

const std = arr => {
  const m = mean(arr);
  return Math.sqrt(mean(arr.map(x => (x - m) ** 2)));
};

/* =========================
   SESSION CONTROLS
========================= */
function startSession() {
  sessionActive = true;

  corpus = [];
  windowed = [];

  windowSize = BASE_WINDOW;
  lastTapTime = null;

  displayValue = 0.5;
  lastDisplay = 0.5;

  updateDisplay();
}

function endSession() {
  sessionActive = false;
}

/* =========================
   TAP
========================= */
function tap() {
  if (!sessionActive) return;

  const now = performance.now();

  if (lastTapTime !== null) {
    const delta = now - lastTapTime;

    corpus.push(delta);

    // windowed corpus (adaptive)
    windowed.push(delta);
    windowed = windowed.filter(d => d < windowSize);

    if (windowed.length >= 3) {
      const instability = std(windowed);

      // adaptive window (INVISIBLE)
      if (instability > 30) {
        windowSize = clamp(
          windowSize + instability * EXPAND_RATE,
          MIN_WINDOW,
          MAX_WINDOW
        );
      } else {
        windowSize = clamp(
          windowSize - windowSize * CONTRACT_RATE,
          MIN_WINDOW,
          MAX_WINDOW
        );
      }

      // normalized estimate (lower delta = better)
      const estimate = clamp(
        1 - mean(windowed) / windowSize,
        0,
        1
      );

      // inertial display update (NO JUMPS)
      displayValue =
        DISPLAY_ALPHA * displayValue +
        (1 - DISPLAY_ALPHA) * estimate;

      updateDisplay();
    }
  }

  lastTapTime = now;
}

/* =========================
   DISPLAY
========================= */
function updateDisplay() {
  const el = document.getElementById("reader");

  const delta = displayValue - lastDisplay;

  el.textContent = displayValue.toFixed(3);

  // STRICT red / green logic
  if (delta > 0) {
    el.style.color = "#2ecc71"; // green
  } else if (delta < 0) {
    el.style.color = "#e74c3c"; // red
  }

  lastDisplay = displayValue;
}
</script>
