<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Specificity</title>

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: manipulation;
  }
  canvas {
    display: block;
  }
  #hint {
    position: fixed;
    bottom: 12px;
    width: 100%;
    text-align: center;
    font-family: system-ui, sans-serif;
    font-size: 11px;
    color: #555;
  }
</style>
</head>

<body>

<canvas id="c"></canvas>
<div id="hint">tap increases instability</div>

<script>
/* =========================
   CORE STATE
========================= */

// latent invariant (slow)
let mean = 0.5;

// perceived surface state (fast)
let x = 0.5;

// dynamics
let noiseAmp = 0.06;
const pull = 0.03;
const meanDecay = 0.0004;

// stability tracking
let lastX = x;
let variance = 0;

/* =========================
   CANVAS
========================= */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* =========================
   AUDIO
========================= */

let audioCtx;
let noiseSource;
let gainNode;
let filterNode;
let audioStarted = false;

function startAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < data.length; i++) {
    data[i] = Math.random() * 2 - 1;
  }

  noiseSource = audioCtx.createBufferSource();
  noiseSource.buffer = buffer;
  noiseSource.loop = true;

  filterNode = audioCtx.createBiquadFilter();
  filterNode.type = "lowpass";

  gainNode = audioCtx.createGain();
  gainNode.gain.value = 0.2; // audible baseline

  noiseSource
    .connect(filterNode)
    .connect(gainNode)
    .connect(audioCtx.destination);

  noiseSource.start();
  audioStarted = true;
}

/* =========================
   INPUT
========================= */

document.body.addEventListener("pointerdown", () => {
  if (!audioStarted) startAudio();
  noiseAmp += 0.008; // destabilization only
});

/* =========================
   UPDATE LOOP
========================= */

function step() {
  // mean relaxes slowly
  mean += (0.5 - mean) * meanDecay;

  // noisy surface update
  x += (Math.random() - 0.5) * noiseAmp;
  x += (mean - x) * pull;
  x = Math.max(0, Math.min(1, x));

  // variance tracking
  const dx = x - lastX;
  variance = 0.98 * variance + 0.02 * dx * dx;
  lastX = x;

  // natural recovery
  noiseAmp *= 0.999;

  updateAudio();
  render();

  requestAnimationFrame(step);
}

/* =========================
   AUDIO MAPPING
========================= */

function updateAudio() {
  if (!audioStarted) return;

  const instability = Math.min(1, variance * 400);

  // loudness tracks instability
  gainNode.gain.value = 0.15 + instability * 0.35;

  // spectral roughness tracks instability
  filterNode.frequency.value =
    300 + (1 - instability) * 900;
}

/* =========================
   VISUAL
========================= */

function render() {
  const img = ctx.createImageData(canvas.width, canvas.height);
  const d = img.data;

  const centerY = canvas.height * mean;

  for (let y = 0; y < canvas.height; y++) {
    const structural =
      Math.exp(-Math.abs(y - centerY) / (canvas.height * 0.25));

    for (let xPix = 0; xPix < canvas.width; xPix++) {
      const i = (y * canvas.width + xPix) * 4;

      const n = (Math.random() - 0.5) * 40;
      const base = 30 + structural * 55 + x * 20;

      d[i] = d[i + 1] = d[i + 2] = base + n;
      d[i + 3] = 255;
    }
  }

  ctx.putImageData(img, 0, 0);
}

/* =========================
   START
========================= */

step();
</script>

</body>
</html>
