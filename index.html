<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Collapse — FIXED</title>

<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #ff0044;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    color: white;
  }
  .box {
    background: rgba(0,0,0,0.5);
    padding: 32px;
    border-radius: 14px;
    text-align: center;
    min-width: 260px;
  }
  #value {
    font-size: 64px;
    margin-bottom: 24px;
  }
  .btn {
    display: block;
    margin: 12px auto;
    padding: 18px 0;
    width: 220px;
    font-size: 22px;
    background: #eee;
    color: #000;
    border-radius: 999px;
  }
  .hint {
    margin-top: 12px;
    font-size: 12px;
    opacity: 0.8;
  }
</style>
</head>
<body>

<div class="box">
  <div id="value">0.0%</div>
  <div class="btn" id="tap">TAP</div>
  <div class="btn" id="reset">RESET</div>
  <div class="hint">DEBUG: NO SIGNS • Collapse vFINAL</div>
</div>

<script>
  let lastTap = null;
  let expected = null;
  let deviation = 0;

  const alpha = 0.25;
  const beta = 0.05;
  const scale = 100;

  const valueEl = document.getElementById("value");

  function clamp(v) {
    return Math.max(0, Math.min(100, v));
  }

  function render() {
    const v = clamp(Math.abs(deviation));
    valueEl.textContent = v.toFixed(1) + "%";
  }

  document.getElementById("tap").onclick = () => {
    const now = performance.now();

    if (lastTap !== null) {
      const interval = (now - lastTap) / 1000;

      if (expected === null) {
        expected = interval;
      } else {
        expected = (1 - beta) * expected + beta * interval;
        const raw = Math.abs(interval - expected) / expected;
        deviation = clamp(alpha * raw * scale + (1 - alpha) * deviation);
      }
    }

    lastTap = now;
    render();
  };

  document.getElementById("reset").onclick = () => {
    lastTap = null;
    expected = null;
    deviation = 0;
    render();
  };

  render();
</script>

</body>
</html>
