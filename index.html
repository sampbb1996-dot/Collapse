<script>
/* =========================
   EXOGENOUS NOISE SOURCES
========================= */

// ---- DEVICE MOTION (jerk magnitude only) ----
let motionEnergy = 0;
let lastAccel = null;

if (window.DeviceMotionEvent) {
  window.addEventListener("devicemotion", e => {
    const a = e.accelerationIncludingGravity;
    if (!a) return;

    const curr = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
    if (lastAccel !== null) {
      const jerk = Math.abs(curr - lastAccel);
      // accumulate but decay quickly
      motionEnergy = Math.min(1, motionEnergy + jerk * 0.02);
    }
    lastAccel = curr;
  });
}

// decay motion noise over time
function decayMotion() {
  motionEnergy *= 0.92;
}
setInterval(decayMotion, 50);

// ---- TIME OF DAY (ultra-slow bias) ----
function timeBias() {
  const hours = new Date().getHours() + new Date().getMinutes()/60;
  // map 24h → [0.95, 1.05]
  return 0.95 + 0.1 * Math.sin((hours / 24) * Math.PI * 2);
}

// ---- BATTERY LEVEL (global damping) ----
let batteryFactor = 1.0;
if (navigator.getBattery) {
  navigator.getBattery().then(b => {
    function updateBattery() {
      // lower battery → more collapse
      batteryFactor = 0.9 + 0.1 * b.level;
    }
    updateBattery();
    b.addEventListener("levelchange", updateBattery);
  });
}

/* =========================
   INTEGRATION INTO AUDIO
========================= */

// call inside your main loop, after ub = biomechU(...)
function applyEnvironmentalCollapse(ub) {
  // motion punishes instability
  const motionPenalty = Math.max(0, 1 - motionEnergy * 0.6);

  // time bias is neutral drift
  const tBias = timeBias();

  // battery is global damping
  return Math.max(
    0,
    Math.min(1, ub * motionPenalty * tBias * batteryFactor)
  );
}
</script>
